<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üîí Token‚ÄëGated Download ‚Äî ERC‚Äë721 (Polygon)</title>

  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- WalletConnect (v2) UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.1/dist/index.umd.min.js"></script>

  <style>
    :root { --card:#0b1220; --ink:#e6ecff; --muted:#9fb0ff; --ok:#22c55e; --err:#f43f5e; --edge:#1f2a44; }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; background: radial-gradient(1200px 600px at 10% -10%,#13203d 0,#0b1220 50%,#090f1a 100%); color:var(--ink); }
    .wrap{ max-width: 860px; margin: 40px auto; padding: 0 16px; }
    .card{ background: linear-gradient(180deg,#0f1830,#0b1220); border:1px solid var(--edge); border-radius: 16px; padding: 22px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1{ margin: 0 0 10px; font-size: 22px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin: 14px 0; }
    button, .btn{
      appearance: none; border:1px solid var(--edge); background:#121b33; color:var(--ink);
      padding:10px 14px; border-radius: 12px; cursor:pointer; font-weight:600;
    }
    button:hover,.btn:hover{ filter:brightness(1.08); }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid var(--edge); color:var(--muted); font-size:12px }
    .status{ margin-top:10px; font-size:14px; color:var(--muted); }
    .ok{ color:var(--ok); font-weight:700 }
    .err{ color:var(--err); font-weight:700 }
    .gate{ margin-top:16px; padding:16px; border:1px dashed var(--edge); border-radius: 12px; text-align:center; }
    .hidden{ display:none; }
    .linkbox{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
    a.btn{ text-decoration:none; }
    .hint{ color:#8ea0ff; font-size:12px; margin-top:8px }
    code{ background:#0f1830; padding:2px 6px; border-radius:6px; border:1px solid var(--edge) }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üîí Token‚ÄëGated Download ‚Äî ERC‚Äë721</h1>
      <div class="row">
        <span class="pill">Network: Polygon (137 / 0x89)</span>
        <span class="pill">Contract: <code id="caddr">0xefc87d60fc234d87286d41c5143b25c1abf38477</code></span>
        <span class="pill">ERC‚Äë721 only</span>
      </div>

      <div class="row">
        <button id="connectMeta">Connect with MetaMask</button>
        <button id="connectWC">Connect with WalletConnect</button>
      </div>

      <div id="status" class="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>

      <div id="locked" class="gate">
        <strong class="err">Locked</strong>
        <div class="hint">‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏∑‡∏≠ NFT ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô (ERC‚Äë721) ‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</div>
        <div class="hint">‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ú‡πà‡∏≤‡∏ô MetaMask App (Browser ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ) ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° WalletConnect</div>
      </div>

      <div id="unlocked" class="gate hidden">
        <strong class="ok">üéâ Unlocked</strong>
        <div class="hint">‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏∑‡∏≠ NFT ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ</div>
        <div class="linkbox">
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏î‡∏≠‡∏±‡∏ô‡πÉ‡∏î‡∏≠‡∏±‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ -->
          <a class="btn" target="_blank" rel="noopener" href="https://ipfs.io/ipfs/bafybeic5vlbjz7g2ddyk7qzhb3lgrpvadxtxnixztxm26r2x4gsm3dzjwe">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å ipfs.io</a>
          <a class="btn" target="_blank" rel="noopener" href="https://cloudflare-ipfs.com/ipfs/bafybeic5vlbjz7g2ddyk7qzhb3lgrpvadxtxnixztxm26r2x4gsm3dzjwe">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å cloudflare-ipfs</a>
        </div>
        <div class="hint">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡∏≠‡∏≠‡∏Å <em>one‚Äëtime download link</em> ‡∏à‡∏≤‡∏Å backend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå</div>
      </div>

    </div>
  </div>

  <script>
    // ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ =====
    const CHAIN_ID_DEC = 137;                  // Polygon Mainnet
    const CHAIN_ID_HEX = "0x89";
    const COLLECTION_ERC721 = "0xefc87d60fc234d87286d41c5143b25c1abf38477";
    const WC_PROJECT_ID = "ba3a040708c3e27acefb4eb4b3c5d9a8";

    // ABI ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ (ERC‚Äë165 ‡∏ï‡∏£‡∏ß‡∏à‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô + ERC‚Äë721 balanceOf)
    const ABI = [
      "function supportsInterface(bytes4 interfaceId) view returns (bool)",
      "function balanceOf(address owner) view returns (uint256)"
    ];
    // interfaceId ‡∏Ç‡∏≠‡∏á ERC‚Äë721
    const IERC721_ID = "0x80ac58cd";

    // ===== ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á DOM =====
    const $ = (id) => document.getElementById(id);
    const elStatus = $("status");
    const elLocked = $("locked");
    const elUnlocked = $("unlocked");

    // ===== Utils =====
    function setStatus(msg, asOk=false, asErr=false){
      elStatus.classList.remove("ok","err");
      if(asOk) elStatus.classList.add("ok");
      if(asErr) elStatus.classList.add("err");
      elStatus.textContent = msg;
    }
    async function ensureChain(provider){
      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡∏•‡∏±‡∏ö Chain (MetaMask ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ)
      try{
        await provider.send("wallet_switchEthereumChain", [{ chainId: CHAIN_ID_HEX }]);
      }catch(e){
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡πá‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô WalletConnect ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å chains ‡πÑ‡∏ß‡πâ‡∏ï‡∏≠‡∏ô init)
      }
    }
    function showLocked(){
      elLocked.classList.remove("hidden");
      elUnlocked.classList.add("hidden");
    }
    function showUnlocked(){
      elLocked.classList.add("hidden");
      elUnlocked.classList.remove("hidden");
    }

    async function checkOwnership(provider){
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á ethers provider
      const web3 = new ethers.providers.Web3Provider(provider, "any");
      await ensureChain(web3);
      const signer = web3.getSigner();
      const addr = await signer.getAddress();

      // ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const net = await web3.getNetwork();
      if (net.chainId !== CHAIN_ID_DEC){
        setStatus(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö ${addr} ‡πÅ‡∏ï‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Polygon (chainId=${net.chainId})`, false, true);
        showLocked();
        return;
      }

      setStatus(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${addr} (Polygon) ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...`);

      const contract = new ethers.Contract(COLLECTION_ERC721, ABI, web3);

      // (1) ‡∏ï‡∏£‡∏ß‡∏à supportsInterface ‡∏Ç‡∏≠‡∏á ERC‚Äë721 (‡∏ñ‡πâ‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞ throw ‚Üí ‡∏à‡∏±‡∏ö‡πÑ‡∏ß‡πâ)
      let isErc721 = false;
      try{
        isErc721 = await contract.supportsInterface(IERC721_ID);
      }catch(e){
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ supportsInterface ‡∏Å‡πá‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ balanceOf ‡πÅ‡∏ö‡∏ö ERC‚Äë721
        isErc721 = true; // optimistic, ‡∏Ñ‡πà‡∏≠‡∏¢‡∏à‡∏±‡∏ö error ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å balanceOf ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ
      }

      if (!isErc721){
        setStatus(`‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà ERC‚Äë721 (‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 0x80ac58cd)`, false, true);
        showLocked();
        return;
      }

      // (2) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å balanceOf(owner) ‚Äî ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ERC‚Äë1155 ‡∏à‡∏∞ revert ‡∏ó‡∏µ‡πà signature ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á
      try{
        const bal = await contract.balanceOf(addr);
        if (ethers.BigNumber.from(bal).gt(0)){
          setStatus(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß: ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏∑‡∏≠ NFT ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚úÖ`, true, false);
          showUnlocked();
        }else{
          setStatus(`‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏∑‡∏≠ NFT ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚ùå`, false, true);
          showLocked();
        }
      }catch(e){
        console.error(e);
        setStatus(`‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ERC‚Äë721 (balanceOf(owner)) ‚Äî ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ERC‚Äë721 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`, false, true);
        showLocked();
      }
    }

    // ===== ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ =====
    $("connectMeta").addEventListener("click", async()=>{
      if (!window.ethereum){
        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö MetaMask ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ ‚Äî ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° WalletConnect ‡πÅ‡∏ó‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô MetaMask App");
        return;
      }
      try{
        const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        await checkOwnership(window.ethereum);
      }catch(e){
        console.error(e);
        setStatus("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MetaMask ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false, true);
      }
    });

    $("connectWC").addEventListener("click", async()=>{
      try{
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á WalletConnect Provider (v2)
        const wc = await window.WalletConnectEthereumProvider.init({
          projectId: WC_PROJECT_ID,
          chains: [CHAIN_ID_DEC],
          optionalChains: [CHAIN_ID_DEC],
          showQrModal: true,
          methods: [
            "eth_requestAccounts","eth_sendTransaction",
            "personal_sign","eth_signTypedData","eth_signTypedData_v4","eth_sign"
          ],
          rpcMap: { [CHAIN_ID_DEC]: "https://polygon-rpc.com" }
        });
        await wc.enable(); // ‡πÅ‡∏™‡∏î‡∏á QR ‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô/‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠

        await checkOwnership(wc);
      }catch(e){
        console.error(e);
        setStatus("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WalletConnect ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", false, true);
      }
    });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    showLocked();
  </script>
</body>
</html>
